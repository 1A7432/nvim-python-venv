# nvim-python-venv

ğŸ å¢å¼ºç‰ˆ Neovim Python è™šæ‹Ÿç¯å¢ƒç®¡ç†æ’ä»¶

ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ Neovim Python è™šæ‹Ÿç¯å¢ƒç®¡ç†æ’ä»¶ï¼Œæ”¯æŒå¤šç§è™šæ‹Ÿç¯å¢ƒç®¡ç†å™¨å’Œæ·±åº¦ LSP é›†æˆã€‚

## âœ¨ ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½

- **é›¶é…ç½®å¯åŠ¨**ï¼šå¼€ç®±å³ç”¨ï¼Œè‡ªåŠ¨æ£€æµ‹å’Œæ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
- **å¤šç®¡ç†å™¨æ”¯æŒ**ï¼šæ”¯æŒ UV, Poetry, Pipenv, Conda, Pyenv, æœ¬åœ° venv, virtualenvwrapper
- **æ™ºèƒ½æ£€æµ‹**ï¼šæŒ‰ä¼˜å…ˆçº§è‡ªåŠ¨æ£€æµ‹é¡¹ç›®ä½¿ç”¨çš„è™šæ‹Ÿç¯å¢ƒç®¡ç†å™¨
- **æ·±åº¦ LSP é›†æˆ**ï¼šæ— ç¼é›†æˆ Pyright, Basedpyright, Pylsp, Jedi Language Server
- **Per-buffer éš”ç¦»**ï¼šä¸åŒ buffer å¯ä½¿ç”¨ä¸åŒè™šæ‹Ÿç¯å¢ƒï¼Œå®Œç¾æ”¯æŒ monorepo
- **æŒä¹…åŒ–ç¼“å­˜**ï¼šä¼šè¯é—´ä¿æŒè™šæ‹Ÿç¯å¢ƒé…ç½®ï¼Œå¿«é€Ÿå¯åŠ¨
- **ä¸°å¯Œå‘½ä»¤ç³»ç»Ÿ**ï¼šæä¾›å®Œæ•´çš„ç”¨æˆ·å‘½ä»¤æ¥ç®¡ç†è™šæ‹Ÿç¯å¢ƒ
- **çŠ¶æ€æ é›†æˆ**ï¼šæä¾› API ç”¨äº lualine ç­‰çŠ¶æ€æ æ’ä»¶æ˜¾ç¤ºå½“å‰è™šæ‹Ÿç¯å¢ƒ

### ğŸ¯ è®¾è®¡åŸåˆ™

- **é›¶é…ç½®ä¼˜å…ˆ**ï¼šé»˜è®¤å…¨è‡ªåŠ¨ï¼Œæ— éœ€é…ç½®å³å¯ä½¿ç”¨
- **æ¸è¿›å¼å¢å¼º**ï¼šæ”¯æŒæ‰‹åŠ¨ç®¡ç†å’Œé«˜çº§é…ç½®ï¼Œæ»¡è¶³å¤æ‚éœ€æ±‚
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šå¼‚æ­¥æ£€æµ‹ã€å¤šå±‚ç¼“å­˜ã€æœ€å°å¯åŠ¨å½±å“
- **å¯æ‰©å±•æ€§**ï¼šæ’ä»¶å¼æ¶æ„ï¼Œæ˜“äºæ·»åŠ æ–°çš„ç®¡ç†å™¨å’Œ LSP

## ğŸ“¦ å®‰è£…

### lazy.nvim

```lua
{
  'nvim-python-venv',
  ft = 'python',
  config = function()
    require('nvim-python-venv').setup()
  end,
}
```

### packer.nvim

```lua
use {
  'nvim-python-venv',
  ft = 'python',
  config = function()
    require('nvim-python-venv').setup()
  end,
}
```

## âš™ï¸ é…ç½®

### é»˜è®¤é…ç½®ï¼ˆé›¶é…ç½®ï¼‰

æ’ä»¶æä¾›å®Œæ•´çš„é»˜è®¤é…ç½®ï¼Œæ— éœ€ä»»ä½•é…ç½®å³å¯ä½¿ç”¨ï¼š

```lua
require('nvim-python-venv').setup()
```

### è‡ªå®šä¹‰é…ç½®

```lua
require('nvim-python-venv').setup({
  -- è‡ªåŠ¨æ£€æµ‹è™šæ‹Ÿç¯å¢ƒ
  auto_detect = true,
  
  -- è‡ªåŠ¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
  auto_activate = true,
  
  -- è™šæ‹Ÿç¯å¢ƒå˜æ›´æ—¶è‡ªåŠ¨é‡å¯ LSP
  auto_restart_lsp = true,

  -- ç¼“å­˜é…ç½®
  cache = {
    enabled = true,
    file_path = vim.fn.stdpath('cache') .. '/nvim-python-venv/cache.json',
    expire_time = 0, -- 0 = æ°¸ä¸è¿‡æœŸ
    auto_clean = true, -- è‡ªåŠ¨æ¸…ç†æ— æ•ˆç¼“å­˜
  },

  -- è™šæ‹Ÿç¯å¢ƒç®¡ç†å™¨é…ç½®
  managers = {
    -- ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
    priority = {
      'uv',
      'poetry',
      'pipenv',
      'conda',
      'pyenv',
      'local_venv',
      'virtualenvwrapper',
    },
    -- å¯ç”¨çš„ç®¡ç†å™¨
    enabled = {
      uv = true,
      poetry = true,
      pipenv = true,
      conda = true,
      pyenv = true,
      local_venv = true,
      virtualenvwrapper = true,
    },
  },

  -- LSP é…ç½®
  lsp = {
    servers = { 'pyright', 'basedpyright', 'pylsp', 'jedi_language_server' },
    restart_on_venv_change = true,
    timeout = 5000,
  },

  -- UI é…ç½®
  ui = {
    selector = 'auto', -- 'auto' | 'telescope' | 'fzf-lua' | 'fzf-vim' | 'nui' | 'vim-ui'
    notify = true,
    notify_level = 'info', -- 'info' | 'warn' | 'error'
    statusline = true,
  },

  -- é’©å­å‡½æ•°
  hooks = {
    on_venv_activate = function(venv_path)
      -- è™šæ‹Ÿç¯å¢ƒæ¿€æ´»æ—¶æ‰§è¡Œ
    end,
    on_venv_deactivate = function()
      -- è™šæ‹Ÿç¯å¢ƒåœç”¨æ—¶æ‰§è¡Œ
    end,
    on_lsp_attach = function(client, bufnr)
      -- LSP é™„åŠ æ—¶æ‰§è¡Œ
    end,
  },
})
```

## ğŸ® ä½¿ç”¨æ–¹æ³•

### ç”¨æˆ·å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ |
|-----|------|
| `:VenvSelect` | é€‰æ‹©å¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ |
| `:VenvActivate <path>` | æ¿€æ´»æŒ‡å®šè·¯å¾„çš„è™šæ‹Ÿç¯å¢ƒ |
| `:VenvDeactivate` | åœç”¨å½“å‰è™šæ‹Ÿç¯å¢ƒ |
| `:VenvAdd` | æ‰‹åŠ¨æ·»åŠ è™šæ‹Ÿç¯å¢ƒæ˜ å°„ |
| `:VenvRemove` | ç§»é™¤è™šæ‹Ÿç¯å¢ƒæ˜ å°„ |
| `:VenvRefresh` | åˆ·æ–°è™šæ‹Ÿç¯å¢ƒåˆ—è¡¨ |
| `:VenvInfo` | æ˜¾ç¤ºå½“å‰è™šæ‹Ÿç¯å¢ƒä¿¡æ¯ |
| `:VenvCacheOpen` | æ‰“å¼€ç¼“å­˜æ–‡ä»¶ |
| `:VenvCacheClear` | æ¸…ç©ºç¼“å­˜ |
| `:VenvLspRestart` | é‡å¯ Python LSP |

### Lua API

```lua
local venv = require('nvim-python-venv')

-- è·å–å½“å‰æ¿€æ´»çš„è™šæ‹Ÿç¯å¢ƒåç§°ï¼ˆç”¨äºçŠ¶æ€æ ï¼‰
local name = venv.get_active_venv()

-- è·å–è™šæ‹Ÿç¯å¢ƒçŠ¶æ€ï¼ˆåŒ…å«å®Œæ•´ä¿¡æ¯ï¼‰
local status = venv.get_venv_status()
-- {
--   name = "my-project",
--   path = "/path/to/.venv",
--   python_version = "3.11.5",
--   manager = "poetry"
-- }

-- è·å–è™šæ‹Ÿç¯å¢ƒå›¾æ ‡
local icon = venv.get_venv_icon() -- ğŸ ğŸ“œ ğŸ…’ ç­‰
```

### çŠ¶æ€æ é›†æˆç¤ºä¾‹

#### lualine.nvim

```lua
require('lualine').setup({
  sections = {
    lualine_x = {
      {
        function()
          local venv = require('nvim-python-venv')
          local status = venv.get_venv_status()
          if status then
            return venv.get_venv_icon() .. ' ' .. status.name
          end
          return ''
        end,
        color = { fg = '#98c379' },
      },
    },
  },
})
```

## ğŸ” è™šæ‹Ÿç¯å¢ƒæ£€æµ‹é€»è¾‘

æ’ä»¶æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è‡ªåŠ¨æ£€æµ‹è™šæ‹Ÿç¯å¢ƒï¼š

```mermaid
graph TD
    Start[å¼€å§‹æ£€æµ‹] --> Cache{æ£€æŸ¥ç¼“å­˜}
    Cache -->|å‘½ä¸­| Return1[è¿”å›ç¼“å­˜ç¯å¢ƒ]
    Cache -->|æœªå‘½ä¸­| UV{UV é¡¹ç›®?}
    UV -->|æ˜¯| Return2[è¿”å› UV ç¯å¢ƒ]
    UV -->|å¦| Poetry{Poetry é¡¹ç›®?}
    Poetry -->|æ˜¯| Return3[è¿”å› Poetry ç¯å¢ƒ]
    Poetry -->|å¦| Pipenv{Pipenv é¡¹ç›®?}
    Pipenv -->|æ˜¯| Return4[è¿”å› Pipenv ç¯å¢ƒ]
    Pipenv -->|å¦| Conda{Conda é¡¹ç›®?}
    Conda -->|æ˜¯| Return5[è¿”å› Conda ç¯å¢ƒ]
    Conda -->|å¦| Pyenv{Pyenv é¡¹ç›®?}
    Pyenv -->|æ˜¯| Return6[è¿”å› Pyenv ç¯å¢ƒ]
    Pyenv -->|å¦| Local{æœ¬åœ° .venv/venv?}
    Local -->|æ˜¯| Return7[è¿”å›æœ¬åœ°ç¯å¢ƒ]
    Local -->|å¦| Wrapper{Virtualenvwrapper?}
    Wrapper -->|æ˜¯| Return8[è¿”å› Wrapper ç¯å¢ƒ]
    Wrapper -->|å¦| Return9[æœªæ‰¾åˆ°]
```

### å„ç®¡ç†å™¨æ£€æµ‹æ ‡å¿—

| ç®¡ç†å™¨ | æ£€æµ‹æ ‡å¿— |
|-------|---------|
| UV | `uv.lock` æ–‡ä»¶ + `.venv` ç›®å½• |
| Poetry | `poetry.lock` æˆ– `pyproject.toml` ä¸­çš„ `[tool.poetry]` |
| Pipenv | `Pipfile` æˆ– `Pipfile.lock` |
| Conda | `environment.yml` æˆ– `environment.yaml` |
| Pyenv | `.python-version` æ–‡ä»¶ |
| æœ¬åœ° venv | `.venv`, `venv`, `.env`, `env` ç›®å½• |
| Virtualenvwrapper | `$WORKON_HOME/<project-name>` ç›®å½• |

## ğŸ”§ å·¥ä½œåŸç†

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·å±‚                              â”‚
â”‚  å‘½ä»¤ / API / è‡ªåŠ¨å‘½ä»¤ / å¿«æ·é”®                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ ¸å¿ƒå±‚                              â”‚
â”‚  Setup ç®¡ç†å™¨ / é…ç½®ç®¡ç† / è™šæ‹Ÿç¯å¢ƒæ ¸å¿ƒ / LSP æ ¸å¿ƒ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è™šæ‹Ÿç¯å¢ƒç®¡ç†å™¨å±‚                        â”‚
â”‚  UV / Poetry / Pipenv / Conda / Pyenv / æœ¬åœ° / Wrapper   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å­˜å‚¨å±‚                              â”‚
â”‚  ç¼“å­˜ç³»ç»Ÿï¼ˆå†…å­˜ + æ–‡ä»¶ï¼‰/ çŠ¶æ€ç®¡ç†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LSP é›†æˆæœºåˆ¶

æ’ä»¶é€šè¿‡ Hook æ³¨å…¥æœºåˆ¶æ·±åº¦é›†æˆ LSPï¼š

1. **root_dir Hook**ï¼šä»ç¼“å­˜ä¼˜å…ˆæŸ¥æ‰¾å·²çŸ¥çš„é¡¹ç›®æ ¹ç›®å½•
2. **on_new_config Hook**ï¼šåœ¨ LSP åˆå§‹åŒ–å‰æ£€æµ‹å¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
3. **on_attach Hook**ï¼šå°†è™šæ‹Ÿç¯å¢ƒè·¯å¾„ä¿å­˜åˆ° buffer å˜é‡

### ç¼“å­˜ç³»ç»Ÿ

ä¸‰å±‚ç¼“å­˜æ¶æ„ç¡®ä¿æ€§èƒ½ï¼š

- **L1 å†…å­˜ç¼“å­˜**ï¼šå½“å‰ä¼šè¯çš„ root_dir -> venv æ˜ å°„
- **L2 æ–‡ä»¶ç¼“å­˜**ï¼šæŒä¹…åŒ–çš„ JSON ç¼“å­˜ï¼Œä¼šè¯é—´ä¿æŒ
- **L3 å…¨å±€ç¯å¢ƒç¼“å­˜**ï¼šå„ç®¡ç†å™¨çš„å…¨å±€è™šæ‹Ÿç¯å¢ƒåˆ—è¡¨



## ğŸ“ å¾…åŠäº‹é¡¹

- [ ] æ–‡ä»¶ç›‘è§†ç³»ç»Ÿï¼ˆè‡ªåŠ¨åˆ·æ–°è™šæ‹Ÿç¯å¢ƒï¼‰
- [ ] Telescope/fzf é€‰æ‹©å™¨é›†æˆ
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–å’ŒåŸºå‡†æµ‹è¯•
- [ ] å®Œæ•´çš„ Vim æ–‡æ¡£

## ğŸ› å·²çŸ¥é—®é¢˜

- Windows æ”¯æŒæœªå……åˆ†æµ‹è¯•
- Conda ç¯å¢ƒè§£æå¯èƒ½ä¸å¤Ÿå¥å£®

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License


